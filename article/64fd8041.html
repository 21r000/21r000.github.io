<!-- build time:Wed Mar 30 2022 11:56:11 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="未入江湖，怎敢佩刀" href="https://www.21r000.xyz/rss.xml"><link rel="alternate" type="application/atom+xml" title="未入江湖，怎敢佩刀" href="https://www.21r000.xyz/atom.xml"><link rel="alternate" type="application/json" title="未入江湖，怎敢佩刀" href="https://www.21r000.xyz/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="内网渗透"><link rel="canonical" href="https://www.21r000.xyz/article/64fd8041.html"><title>windows认证系列和域前置的简单了解 - 内网渗透 | 21r000 = 未入江湖，怎敢佩刀 = 你的骑士还没有来，你就永远是我的公主。</title><meta name="generator" content="Hexo 6.0.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">windows认证系列和域前置的简单了解</h1><div class="meta"><span class="item" title="创建时间：2021-12-16 20:48:36"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-12-16T20:48:36+08:00">2021-12-16</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>11k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>10 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">21r000</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211228150421805.png"></li><li class="item" data-background-image="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/6833939bly1gicljitigmj20zk0m87fp.jpg"></li><li class="item" data-background-image="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/6833939bly1gipetlbztpj20zk0m84qp.jpg"></li><li class="item" data-background-image="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/6833939bly1gipexw3o58j20zk0m8e81.jpg"></li><li class="item" data-background-image="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/6833939bly1gipet8c1a2j20zk0m8kct.jpg"></li><li class="item" data-background-image="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2022/b16488d44c2e0639b39880ced723fbf.png"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" itemprop="item" rel="index" title="分类于 内网渗透"><span itemprop="name">内网渗透</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.21r000.xyz/article/64fd8041.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="21r000"><meta itemprop="description" content="你的骑士还没有来，你就永远是我的公主。, 固态规则长方体空间移动工程师"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="未入江湖，怎敢佩刀"></span><div class="body md" itemprop="articleBody"><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126131916790.png" alt="image-20211126131916790"></p><h3 id="00x01windows之ntlm认证"><a class="anchor" href="#00x01windows之ntlm认证">#</a> 00x01.Windows 之 NTLM 认证</h3><p>NTLM 认证主要有本地认证和网络认证两种方式</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>本地登陆时用户密码存储在<span class="token constant">SAM</span>文件中，可以把它当作一个存储密码的数据库，所有的操作都在本地进行的。它将用户输入的密码转换为<span class="token constant">NTLM</span> Hash<span class="token punctuation">,</span>然后与<span class="token constant">SAM</span>中的<span class="token constant">NTLM</span> Hash进行比较。</pre></td></tr><tr><td data-num="2"></td><td><pre>网络认证则是基于一种Challenge<span class="token operator">/</span>Response认证机制的认证模式。</pre></td></tr></table></figure><p>windows 本地认证基础知识</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>在本地登陆的情况下，操作系统会使用用户输入的密码作为凭据去与系统中的密码进行校验，如果成功的话表明验证通过。</pre></td></tr><tr><td data-num="2"></td><td><pre>操作系统的密码存储在<span class="token constant">C</span>盘的目录下：<span class="token operator">%</span>SystemRoot<span class="token operator">%</span>\system32\config\sam</pre></td></tr></table></figure><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126130422489.png" alt="image-20211126130422489"></p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token constant">SAM</span>用于储存本地所有用户的凭证信息，但是这并不代表着你可以随意去查看系统密码。我们登陆系统的时候系统会自动读取<span class="token constant">SAM</span>文件中的密码与我们输入的密码进行比对，如果认证相同则可以使用该机器。</pre></td></tr><tr><td data-num="2"></td><td><pre>windows自身是不会保存明文密码的，也就是说<span class="token constant">SAM</span>中保存的不是明文而是Hash。</pre></td></tr></table></figure><h4 id="ntlm的认证过程"><a class="anchor" href="#ntlm的认证过程">#</a> NTLM 的认证过程</h4><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token constant">NTLM</span> Hash是怎么样生成的呢？当用户注销、重启、锁屏后，操作系统会让winlogon显示登陆界面，当winlogon<span class="token punctuation">.</span>exe接收到账号密码输入之后，会将密码交给lsass进程，这个进程会存一份明文密码，将明文密码加密成<span class="token constant">NTLM</span> Hash，对<span class="token constant">SAM</span><span class="token function">数据库比较认证。</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>winlogon<span class="token punctuation">.</span>exe即Windows Logon Process，是Windows <span class="token constant">NT</span>用户登陆程序，用于管理用户登录和退出。<span class="token constant">LSASS</span>用于微软Windows系统的安全机制。它用于本地安全和登陆策略。<span class="token punctuation">)</span></pre></td></tr></table></figure><p>比如当用户输入密码 <code>admin</code> 的时候，操作系统会将 <code>admin转换为16进制</code> ，经过 <code>Unicode转换</code> 后，再调用 <code>MD4加密算法加密</code> ，这个加密结果的 <code>十六进制</code> 就是 <code>NTLM Hash</code></p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>admin <span class="token operator">-</span><span class="token operator">></span> <span class="token function">hex</span><span class="token punctuation">(</span><span class="token number">16</span>进制编码<span class="token punctuation">)</span> <span class="token operator">=</span> 61646d696e</pre></td></tr><tr><td data-num="2"></td><td><pre>61646d696e <span class="token operator">-</span><span class="token operator">></span> Unicode <span class="token operator">=</span> 610064006d0069006e00</pre></td></tr><tr><td data-num="3"></td><td><pre>610064006d0069006e00 <span class="token operator">-</span><span class="token operator">></span> <span class="token constant">MD4</span> <span class="token operator">=</span> 209c6174da490caeb422f3fa5a7ae634</pre></td></tr></table></figure><p>加密脚本：</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> hashlib</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> binascii</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>Description <span class="token operator">=</span> <span class="token triple-quoted-string string">'''</span></pre></td></tr><tr><td data-num="5"></td><td><pre>NTLM计算过程</pre></td></tr><tr><td data-num="6"></td><td><pre>admin -> hex = 61646d696e</pre></td></tr><tr><td data-num="7"></td><td><pre>61646d696e-> Unicode = 610064006d0069006e00</pre></td></tr><tr><td data-num="8"></td><td><pre>610064006d0069006e00 -> MD4 = 209c6174da490caeb422f3fa5a7ae634</pre></td></tr><tr><td data-num="9"></td><td><pre>'''</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>Description<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>Password <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'Your Password:'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token builtin">hash</span> <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">'md4'</span><span class="token punctuation">,</span>Password<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-16le'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>hash_hex <span class="token operator">=</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span><span class="token builtin">hash</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'->'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>hash_hex<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h4 id="本地认证的流程"><a class="anchor" href="#本地认证的流程">#</a> 本地认证的流程</h4><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>winlogon<span class="token punctuation">.</span>exe <span class="token operator">-</span><span class="token operator">></span> 接收用户输入 <span class="token operator">-</span><span class="token operator">></span> lsass<span class="token punctuation">.</span>exe <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span>认证<span class="token punctuation">)</span></pre></td></tr></table></figure><p><code>Windows Logon Process(即 winlogon.exe)</code> ，是 <code>Windows NT</code> 用户登 陆程序，用于管理用户登录和退出。</p><p><code>LSASS</code> 用于微软 Windows 系统的安全机 制。它用于本地安全和登陆策略。</p><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126130927563.png" alt="image-20211126130927563"></p><h4 id="windows网络认证"><a class="anchor" href="#windows网络认证">#</a> <strong>windows 网络认证</strong></h4><p>在工作组中，无论是局域网中的一台机器还是很多机器，它们能够通信的话都无法相互建立一个完美的信任机制。只要有一个可以信任的信托机构，对两方进行认证，这样就有第三方来证实双方的可信任性。</p><p>在了解认证之前先了解一些 SMB 协议：</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token constant">SMB</span>（ServerMessage <span class="token function">Block）通信协议是微软（Microsoft）和英特尔</span><span class="token punctuation">(</span>Intel<span class="token punctuation">)</span>在<span class="token number">1987</span>年制定的协议，主要是作为Microsoft网络的通讯协议。<span class="token constant">SMB</span> 是在会话层（session layer）和表示层（presentation layer）以及小部分应用层（application layer）的协议。<span class="token constant">SMB</span>使用了NetBIOS的应用程序接口 （Application Program Interface，简称<span class="token constant">API</span>），一般端口使用为<span class="token number">139</span>，<span class="token number">445</span>。另外，它是一个开放性的协议，允许了协议扩展——使得它变得更大而且复杂；大约有<span class="token number">65</span>个最上层的作业，而每个作业都超过<span class="token number">120</span>个函数，甚至Windows <span class="token constant">NT</span>也没有全部支持到，最近微软又把 <span class="token constant">SMB</span> 改名为 <span class="token constant">CIFS</span>（CommonInternet File System），并且加入了许多新的特色。</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>早期<span class="token constant">SMB</span>协议在网络上传输的是明文口令。后来出现<span class="token constant">LAN</span> Manager ChallengeReponse 验证机制，简称<span class="token constant">LM</span>。</pre></td></tr><tr><td data-num="4"></td><td><pre>微软提出了windowsNT挑战<span class="token operator">/</span>响应验证机制，简称<span class="token constant">MTLM</span>。现在已经更新到了<span class="token constant">V2</span>版本以及加入了Kerberos验证体系</pre></td></tr></table></figure><h4 id="ntlm-协议"><a class="anchor" href="#ntlm-协议">#</a> <strong>NTLM 协议</strong></h4><p>NTLM 是一种网络认证协议，它是基于 <code>挑战（Chalenge）/响应（Response）</code> 认证机制的一种认证模式。(这个协议只支持 Windows)</p><p>NTLM 协议的认证共需要三个消息完成：协商 --&gt; 挑战 --&gt; 认证。</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>协商：主要用于确认双方协议版本、加密等级等</pre></td></tr><tr><td data-num="2"></td><td><pre>挑战：服务器在收到客户端的协商消息之后， 会读取其中的内容，并从中选择出自己所能接受的服务内容，加密等级，安全服务等等。并生成一个随机数challenge<span class="token punctuation">,</span> 然后生成challenge消息返回给客户端。该消息就是挑战<span class="token operator">/</span>响应认证机制的主要功能体现。</pre></td></tr><tr><td data-num="3"></td><td><pre>认证：验证主要是在挑战完成后，验证结果，是认证的最后一步。</pre></td></tr></table></figure><p>质询的完整过程：</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1.</span><span class="token function">客户端向服务器端发送用户信息</span><span class="token punctuation">(</span>用户名<span class="token punctuation">)</span>请求</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2.</span>服务器接受到请求，生成一个<span class="token number">16</span>位的随机数，被称之为“Challenge”， 使用登录用户名对应的<span class="token constant">NTLM</span> <span class="token function">Hash加密Challenge</span><span class="token punctuation">(</span><span class="token number">16</span>位随机字符<span class="token punctuation">)</span>， <span class="token function">生成Challenge1。同时，生成Challenge1后，将Challenge</span><span class="token punctuation">(</span><span class="token number">16</span>位随机 字符<span class="token punctuation">)</span>发送给客户端。</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3.</span>客户端接受到Challenge后，使用将要登录到账户对应的<span class="token constant">NTLM</span> Hash加密Challenge生成Response，然后将Response发送至服务器端。</pre></td></tr></table></figure><p>其中，经过 NTLM Hash 加密 Challenge 的结果在网络协议中称之为 Net NTLM Hash。</p><p>验证：服务器端收到客户端的 Response 后，比对 Chanllenge1 与 Response 是否相等，若相等，则认证通过。</p><p><strong>详细过程：</strong></p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1</span><span class="token punctuation">.</span>Server接收到Client发送的用户名后，判断本地账户列 表是否有用户名share_user 如果没有，返回认证失败 如果有，生成Chanllenge，并且从本地查找share_user对 应的<span class="token constant">NTLM</span> Hash，使用<span class="token constant">NTLM</span> Hash加密Chanllenge，生成一 个Net<span class="token operator">-</span><span class="token constant">NTLM</span> Hash存在内存中，并将Chanllenge发送给Client。</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2</span><span class="token punctuation">.</span>Client接收到Chanllenge后，将自己提供的share_user的密码转换为<span class="token constant">NTLM</span> Hash，使用<span class="token constant">NTLM</span> Hash加密Chanllenge， 这个结果叫Response，表现形式是Net<span class="token operator">-</span><span class="token constant">NTLM</span> Hash，最后将Response发送给Server。</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3</span><span class="token punctuation">.</span>Server接收到Client发送的Response，将Response与之 前的Net<span class="token operator">-</span><span class="token constant">NTLM</span> Hash进行比较，如果相等，则认证通过。</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token literal-property property">注意</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">.</span>Chanllenge是Server产生的一个<span class="token number">16</span>字节的随机数，每次认证都不同 <span class="token number">2</span><span class="token punctuation">.</span>Response的表现形式是Net<span class="token operator">-</span><span class="token constant">NTLM</span> Hash，它是由客户端 提供的密码Hash加密Server返回的Chanllenge产生的结果。</pre></td></tr></table></figure><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126132012656.png" alt="image-20211126132012656"></p><p><strong>NTLM 协议 V1 与 V2 的区别</strong></p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token constant">NTLM</span> v1与<span class="token constant">NTLM</span> v2最显著的区别就是Challenge与加密算法不同，共同点就是加密的原料都是<span class="token constant">NTLM</span> Hash。</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token literal-property property">Challage</span><span class="token operator">:</span><span class="token constant">NTLM</span> v1的Challenge有<span class="token number">8</span>位，<span class="token constant">NTLM</span> v2的Challenge为<span class="token number">16</span>位。</pre></td></tr><tr><td data-num="3"></td><td><pre>Net<span class="token operator">-</span><span class="token constant">NTLM</span> <span class="token literal-property property">Hash</span><span class="token operator">:</span><span class="token constant">NTLM</span> v1的主要加密算法是<span class="token constant">DES</span>，<span class="token constant">NTLM</span> v2的主要加密算法是<span class="token constant">HMAC</span><span class="token operator">-</span><span class="token constant">MD5</span>。</pre></td></tr></table></figure><h4 id="内网渗透常用端口"><a class="anchor" href="#内网渗透常用端口">#</a> <strong>内网渗透常用端口</strong></h4><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">53</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token constant">DNS</span>服务，在使用中需要用到<span class="token constant">TCP</span><span class="token operator">/</span><span class="token constant">UDP</span> <span class="token number">53</span>端口，<span class="token constant">AD</span>域的核心就是<span class="token constant">DNS</span>服务器，<span class="token constant">AD</span>通过<span class="token constant">DNS</span>服务器定位资源</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">88</span></pre></td></tr><tr><td data-num="4"></td><td><pre>Kerberos服务，在使用中需要用到<span class="token constant">TCP</span><span class="token operator">/</span><span class="token constant">UDP</span> <span class="token number">88</span><span class="token function">端口，Kerberos密钥分发中心</span><span class="token punctuation">(</span><span class="token constant">KDC</span><span class="token punctuation">)</span> 在该端口上侦听Ticket请求</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">135</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">135</span>端口主要用于使用<span class="token constant">RPC</span>协议并提供<span class="token constant">DCOM</span>服务。</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">137</span></pre></td></tr><tr><td data-num="8"></td><td><pre>NetBIOS<span class="token operator">-</span><span class="token constant">NS</span><span class="token punctuation">(</span>名称服务<span class="token punctuation">)</span>，在使用中需要用到<span class="token constant">TCP</span><span class="token operator">/</span><span class="token constant">UDP</span> <span class="token number">137</span>端口</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">139</span></pre></td></tr><tr><td data-num="10"></td><td><pre>Session <span class="token function">Server</span><span class="token punctuation">(</span>会话服务<span class="token punctuation">)</span><span class="token punctuation">,</span>在使用中需要用到<span class="token constant">TCP</span><span class="token operator">/</span><span class="token constant">UDP</span> <span class="token number">139</span>端口，允许两台计算机建立连接</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">389</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token constant">LDAP</span><span class="token function">服务</span><span class="token punctuation">(</span>轻量级目录访问协议<span class="token punctuation">)</span>，在使用中需要用到<span class="token constant">TCP</span><span class="token operator">/</span><span class="token constant">UDP</span> <span class="token number">389</span>端口，如果需要使用<span class="token constant">SSL</span>，需要使用<span class="token number">636</span>端口，</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">445</span></pre></td></tr><tr><td data-num="14"></td><td><pre>主要用于共享文件夹或共享打印，存在较多漏洞，如<span class="token constant">MS08</span><span class="token operator">-</span><span class="token number">067</span>、<span class="token constant">MS17</span><span class="token operator">-</span><span class="token number">010</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token number">3268</span> Global <span class="token function">Catalog</span><span class="token punctuation">(</span>全局编录服务器<span class="token punctuation">)</span>，如果需要使用<span class="token constant">SSL</span>，需要用到<span class="token number">3269</span>端口，主要用于用户登录时，负责验证用户身份的域控制器需要通过防火</pre></td></tr><tr><td data-num="16"></td><td><pre>墙，来向“全局编录”查询用户所隶属的通用组</pre></td></tr></table></figure><h4 id="ntlm身份验证"><a class="anchor" href="#ntlm身份验证">#</a> NTLM 身份验证</h4><p>NTLM 验证是一种 Challenge/Response 验证机制，由三种消息组成：通常称为 type 1 (协商)，类型 type 2 (质询) 和 type 3 (身份验证)。</p><p>它基本上是这样工作的:</p><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126132650233.png" alt="image-20211126132650233"></p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1.</span> 用户登录客户端电脑</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2.</span> <span class="token punctuation">(</span>type <span class="token number">1</span><span class="token punctuation">)</span>客户端向服务器发送type <span class="token number">1</span><span class="token punctuation">(</span>协商<span class="token punctuation">)</span>消息<span class="token punctuation">,</span>它主要包含客户端支持和服务器请求的功能列表。</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3.</span> <span class="token punctuation">(</span>type <span class="token number">2</span><span class="token punctuation">)</span>服务器用type <span class="token number">2</span><span class="token function">消息</span><span class="token punctuation">(</span>质询<span class="token punctuation">)</span>进行响应，这包含服务器支持和同意的功能列表。但是，最重要的是，它包含服务器产生的Challenge。</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">4.</span> <span class="token punctuation">(</span>type <span class="token number">3</span><span class="token punctuation">)</span>客户端用type <span class="token number">3</span><span class="token function">消息</span><span class="token punctuation">(</span>身份验证<span class="token punctuation">)</span>回复质询。用户接收到步骤<span class="token number">3</span>中的challenge之后，使用用户hash与challenge进行加密运算得到response，将response<span class="token punctuation">,</span>username<span class="token punctuation">,</span>challeng发给服务器。消息中的response是最关键的部分，因为它们向服务器证明客户端用户已经知道帐户密码。</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">5.</span> 服务器拿到type <span class="token number">3</span>之后，使用challenge和用户hash进行加密得到response2与type <span class="token number">3</span>发来的response进行比较。如果用户hash是存储在域控里面的话，那么没有用户hash，也就没办法计算response2。也就没法验证。这个时候用户服务器就会通过netlogon协议联系域控，建立一个安全通道<span class="token punctuation">,</span>然后将type <span class="token number">1</span><span class="token punctuation">,</span>type <span class="token number">2</span>，type3 <span class="token function">全部发给域控</span><span class="token punctuation">(</span>这个过程也叫作Pass Through Authentication认证流程<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">6.</span> 域控使用challenge和用户hash进行加密得到response2，与type <span class="token number">3</span>的response进行比较</pre></td></tr></table></figure><p>下面简单介绍下三个过程，如果对于细节不感兴趣的话就可以忽略。</p><p><strong>type 1 协商</strong></p><p>这个过程是客户端向服务器发送 type 1 (协商) 消息，它主要包含客户端支持和服务器请求的功能列表。</p><p>主要包含以下结构</p><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126132807866.png" alt="image-20211126132807866"></p><p>抓包查看对应的信息如下</p><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126132832171.png" alt="image-20211126132832171"></p><p><strong>type 2 质询</strong></p><p>这个过程是服务器用 type 2 消息 (质询) 进行响应，这包含服务器支持和同意的功能列表。但是，最重要的是，它包含服务器产生的 Challenge。</p><p>主要 包含以下结构</p><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126132903616.png" alt="image-20211126132903616"></p><p><strong>type 3 身份验证</strong></p><p>这个过程客户端接收到 challenge 之后，使用用户 hash 与 challenge 进行加密运算得到 response，将 response,username,challenge 发给服务器。消息中的 response 是最关键的部分，因为它向服务器证明客户端用户已经知道帐户密码。</p><p>主要包含以下结构</p><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126133114164.png" alt="image-20211126133114164"></p><p>这里的 Challeng 不同于 type2 的 Challenge，这里的 Challenge 是一个随机的客户端 nonce。</p><p>MIC 是校验和，设计 MIC 主要是为了防止这个包中途被修改</p><p>sessionkey 是在要求进行签名的时候用的，用来进行协商加密密钥，可能有些文章会说 sessionkey 就是加密密钥，需要拥有用户 hash 才能计算出来，因此攻击者算不出来，就无法加解密包。但是想想就不可能，这个 session_key 已经在流量里面明文传输，那攻击者拿到之后不就可以直接加解密包了。当然这是后话，后面讲签名的时候会详细讲讲这个问题。</p><h3 id="00x02windows之kerberos认证"><a class="anchor" href="#00x02windows之kerberos认证">#</a> 00x02.Windows 之 Kerberos 认证</h3><h4 id="域认证kerberos"><a class="anchor" href="#域认证kerberos">#</a> 域认证 Kerberos</h4><p>域内认证不再是两台机器之间互相请求认证，而是通过第三方可信机构 KDC（Key Distribute Center）来实现整个认证体系</p><h4 id="系统角色"><a class="anchor" href="#系统角色">#</a> 系统角色</h4><p>参与域认证的三个角色：</p><ul><li>Client</li><li>Server</li><li>KDC(Key Distribution Center) = AD（Account Database）+ AS（Authenication Service）+ TGS（Ticket Granting Service）</li></ul><p>从物理层面看，KDC 的角色实际为域控制器 (Domain Controller)，其中包含 AD 数据库与 AS 服务，TGS 服务。</p><h4 id="kerberos相关的几个概念"><a class="anchor" href="#kerberos相关的几个概念">#</a> Kerberos 相关的几个概念：</h4><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token constant">KDC</span><span class="token punctuation">(</span>Key Distribution Center<span class="token punctuation">)</span><span class="token operator">:</span>密钥分发中心</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token constant">AS</span><span class="token punctuation">(</span>Authentication Server<span class="token punctuation">)</span><span class="token operator">:</span>身份认证服务</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token constant">TGT</span><span class="token punctuation">(</span>Ticket Granting Ticket<span class="token punctuation">)</span>：由<span class="token constant">AS</span>身份认证服务提供的票据也称为黄金票据，用于身份认证，存储在内存，默认有效期为<span class="token number">10</span>小时。</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token constant">TGS</span><span class="token punctuation">(</span>Ticket Granting Server<span class="token punctuation">)</span>：由<span class="token constant">TGS</span>服务提供的票据也称为白银票据，用于发出所请求服务的票证。</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token constant">AD</span>，全称叫Account Database，被称作活动目录数据库，存放在域控<span class="token constant">NTDS</span><span class="token punctuation">.</span><span class="token constant">DIT</span>文件中，存储域中所有用户的用户名和对应的<span class="token constant">NTLM</span> Hash，<span class="token constant">KDC</span>可以从<span class="token constant">AD</span>中提取域中所有用户的<span class="token constant">NTLM</span> Hash，这是Kerberos协议能够成功实现的基础。</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token constant">AS</span>，全称叫Authenication Service，是<span class="token constant">KDC</span>的组件之一，处理初始请求并负责发出<span class="token constant">TGT</span>给Client，用来完成对Client的身份验证。</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token constant">TGS</span>，全称叫Ticket Granting Service，也是<span class="token constant">KDC</span>的组件之一，从<span class="token constant">AS</span>那里拿到<span class="token constant">TGT</span>之后，<span class="token constant">TGS</span>再发出对某个特定服务或服务器访问的Ticket，这个Ticket允许对某个服务访问。</pre></td></tr></table></figure><h4 id="kerbreros认证流程"><a class="anchor" href="#kerbreros认证流程">#</a> Kerbreros 认证流程</h4><p>下图显示了 Client、Server、KDC 三者的协议交互过程。</p><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126152356684.png" alt="image-20211126152356684"></p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>Client向<span class="token constant">KDC</span>发起服务请求，希望获取访问Server的权限。 <span class="token constant">KDC</span>得到了这个消息，首先得判断Client是否是可信赖的， 也就是从<span class="token constant">AD</span>数据库中寻找该用户是否可用来登录。这就是<span class="token constant">AS</span>服务完成的工作，成功后，<span class="token constant">AS</span>返回<span class="token constant">TGT</span>给Client。</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>Client得到了<span class="token constant">TGT</span>后，继续向<span class="token constant">KDC</span>请求，希望获取访问Server的权限。<span class="token constant">KDC</span>又得到了这个消息，这时候通过Client 消息中的<span class="token constant">TGT</span>，判断出了Client拥有了这个权限，给了Client访问Server的权限Ticket。（<span class="token constant">TGS</span>服务的任务）</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>Client得到Ticket后便可以使用这个Ticket成功访问Server。但是这个Ticket只能用来访问这个Server，如果要访问其他Server需要向<span class="token constant">KDC</span>重新申请。</pre></td></tr></table></figure><h5 id="具体过程"><a class="anchor" href="#具体过程">#</a> 具体过程</h5><h5 id="1-用户登陆"><a class="anchor" href="#1-用户登陆">#</a> 1、用户登陆</h5><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126152655700.png" alt="image-20211126152655700"></p><ul><li>用户输入 <strong>用户名</strong> 和 <strong>密码</strong> 信息</li><li>在客户端，用户输入的 <strong>密码</strong> 通过计算生成 NTLM 哈希作做为 <strong>CLIENT 密钥</strong></li></ul><h5 id="2-身份认证服务as认证流程"><a class="anchor" href="#2-身份认证服务as认证流程">#</a> 2、身份认证服务（AS）认证流程</h5><h6 id="21-客户端向as发送认证请求"><a class="anchor" href="#21-客户端向as发送认证请求">#</a> 2.1 客户端向 AS 发送认证请求</h6><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126153013290.png" alt="image-20211126153013290"></p><ul><li>客户端向 AS 发送带有明文 <strong>用户名</strong> 的认证请求</li></ul><h6 id="22-as确认client端登录者用户身份"><a class="anchor" href="#22-as确认client端登录者用户身份">#</a> 2.2 AS 确认 Client 端登录者用户身份</h6><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126153052593.png" alt="image-20211126153052593"></p><p>1、AS 从 AD 数据库中查找该用户是否存在。<br>2、如果该 <strong>用户名</strong> 存在，则 AS 使用用户密码生成密钥，然后对响应消息<strong> Msg A</strong> 进行加密。如果找不到，则将错误消息返回给客户端。<br>3、AS 使用 TGS 密钥对<strong> Msg B</strong> 进行加密。<br>4、AS 将<strong> Msg A</strong> 和<strong> Msg B</strong> 返回给客户端。<br>5、客户端使用用户的密钥解密 <strong>Msg A</strong>。请注意，客户端无法解密 <strong>Msg B</strong>。</p><ul><li><p>TGT（<strong>Msg B</strong>）中包含如下信息：</p><p>– [Client/TGS SessionKey]<br>– Client ID<br>– Ticket 有效时间<br>– Client 地址</p></li></ul><p>6、从解密的 Msg A 中提取的 Client/TGS SessionKey（Client/TGS 会话密钥）。</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>客户端无法解密Msg <span class="token constant">B</span>，即无法解密<span class="token constant">TGT</span>，解密需要<span class="token constant">TGS</span>密钥，但是密钥存在于<span class="token constant">KDC</span>上</pre></td></tr><tr><td data-num="2"></td><td><pre>需要了解：<span class="token constant">TGS</span>密钥 <span class="token operator">==</span> <span class="token constant">KDC</span> Hash <span class="token operator">==</span> krbtgt用户的<span class="token constant">NTLM</span> Hash</pre></td></tr></table></figure><p>AS 响应的消息中有一条是属于 Client 的，但另外一条却属于 TGS。<br>认证过程中的加密除哈希外均采用的是对称加密算法。</p><h5 id="3-票据授予服务tgs认证流程"><a class="anchor" href="#3-票据授予服务tgs认证流程">#</a> 3、票据授予服务（TGS）认证流程</h5><h6 id="31-客户端向tgs发送请求服务授权请求"><a class="anchor" href="#31-客户端向tgs发送请求服务授权请求">#</a> 3.1 客户端向 TGS 发送请求服务授权请求</h6><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126153258376.png" alt="image-20211126153258376"></p><p>1、客户端发送消息 Msg C，以及 Msg D</p><ul><li><p><strong>Msg C</strong><br>– 要请求的服务 ID, 即 [Service ID]<br>– 上一步 2.2 中由 AS 为 Client 提供的 TGT。</p></li><li><p><strong>Msg D</strong><br>– 使用 Client/TGS SessionKey 加密的 Authenticator 1 {Client ID, Timestamp}。</p></li></ul><p>2、TGS 获取两个请求 <strong>Msg C</strong> 和 <strong>Msg D</strong>，先从 <strong>Msg C</strong> 中获取 TGT 以及服务 ID。</p><p>3、TGS 接下来使用 TGS 密钥（即 krbtgt 用户的 NTLM Hash）解密 TGT，从 TGT 中提取到 <strong>Client/TGS SessionKey</strong> ，TGS 现在有了<strong> Client/TGS SessionKey</strong>。</p><p>4、TGS 此时使用 <strong>Client/TGS SessionKey</strong> 解密<strong> Msg D</strong>，获得 Authenticator 1 {Client ID, Timestamp}。</p><p>5、TGS 比较 <strong>Msg C</strong> 以及 Msg D 获取到的 Client ID。</p><p>6、如果相同 TGS 生成 <strong>Msg E</strong> 以及<strong> Msg F</strong>，不同则报错误。</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token constant">TGT</span>在其生命周期内被缓存，并用于请求客户端需要的每个新服务票证。</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token constant">CLIENT</span><span class="token operator">/</span><span class="token constant">TGS</span> <span class="token constant">SESSIONKEY</span>也由客户端缓存。</pre></td></tr></table></figure><h6 id="32-tgs为client响应服务授权票据"><a class="anchor" href="#32-tgs为client响应服务授权票据">#</a> 3.2 TGS 为 Client 响应服务授权票据</h6><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126153837025.png" alt="image-20211126153837025"></p><p>1、客户端接收到 TGS 发送的 <strong>Msg E</strong> 以及 Msg F</p><ul><li><p><strong>Msg E</strong> 使用 <strong>SERVICE 密钥</strong> (服务器的 NTLM HASH) 加密的 <strong>CLIENT-TO-SERVER TICKET</strong>，该 Ticket 中包含了如下信息:<br>– [Client/Server SessionKey]<br>– Client 网络地址<br>– Ticket 有效时间<br>– Client ID</p></li><li><p><strong>Msg F</strong> 使用 <code>Client/TGS SessionKey</code> 加密的 <code>Client/Server SessionKey</code></p></li></ul><p>2、客户端使用 <code>CLIENT/TGS SESSIONKEY</code> 解密 <code>Msg F</code> 获得 <code>CLIENT/SERVER SESSIONKEY</code></p><ul><li><strong>Msg E</strong> 使用了 <strong>[SERVICE 密钥]</strong> 加密，该消息可视作是 TGS 给 Service Server 的消息，只不过由 Client 一起携带发送给 Service Server</li></ul><h5 id="4发送服务请求"><a class="anchor" href="#4发送服务请求">#</a> 4. 发送服务请求</h5><h6 id="41-client向service-server发送服务请求"><a class="anchor" href="#41-client向service-server发送服务请求">#</a> 4.1 Client 向 Service Server 发送服务请求</h6><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126154223422.png" alt="image-20211126154223422"></p><p>1、客户端生成 <strong>Msg E</strong> 和 <strong>Msg G</strong>（Authenticator 2）。</p><ul><li><strong>Msg E</strong> 上一步 3.2 中，TGS 为客户端响应的消息 <strong>Msg E</strong>。该消息可以理解为由客户端携带的消息。</li><li><strong>Msg G</strong> 由 Client/Server SessionKey 加密的 Authenticator 2，包含 {Client ID, Timestamp} 信息。</li></ul><p>2、客户端将 <strong>Msg E</strong> 和 <strong>Msg G</strong> 发送到服务器（SS）。<br>3、服务器使用其自己的密钥对 <strong>Msg E</strong>（ticket）进行解密，得到 <strong>Client/Server SessionKey</strong><br>4、服务器使用上一步得到的 <strong>Client/Server SessionKey</strong> 解密 <strong>Msg G</strong><br>5、比较消息 <strong>Msg E</strong> 和 <strong>Msg G</strong> 中的 Client ID。<br>6、如果匹配，则将<strong> Msg H</strong> 发送给客户端，以确认服务器身份和服务客户端请求的意愿（此部分是可选的）。</p><h6 id="42-service-server响应client"><a class="anchor" href="#42-service-server响应client">#</a> 4.2 Service Server 响应 Client</h6><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126154431559.png" alt="image-20211126154431559"></p><p>1、客户端收到 Msg H。</p><ul><li>Msg H 是 Client/Server SessionKey 加密的时间戳</li></ul><p>2、客户端使用 Client/Server SessionKey 解密 Msg H。<br>3、客户端检查 Msg H 的时间戳。<br>4、客户端现在信任服务器，可以与服务器进行交互。</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>来自<span class="token constant">SS</span>的响应（Msg <span class="token constant">H</span>）是可选的。仅在客户端希望<span class="token constant">SS</span>对其自身进行身份验证时才需要这样做（即相互身份验证）。</pre></td></tr></table></figure><h6 id="认证流程中需要关注的点票据伪造的原理"><a class="anchor" href="#认证流程中需要关注的点票据伪造的原理">#</a> <strong>认证流程中需要关注的点，票据伪造的原理</strong></h6><ul><li><p>2.2 AS 确认 Client 端登录者用户身份<br>– KDC 返回的 Msg B：使用 TGS 密钥 (KDCHASH/KRBTGT 用户 NTLMHASH) 加密的 TGT (Ticket-Granting-Ticket)，当我们获取到 krbtgt 用户的 NTLM 哈希后，便可主动使用 krbtgt 用户的 NTLM 哈希做为 TGS 密钥来生成 TGT 发送给 KDC，这样 KDC 如果通过解密伪造 TGT 获取到伪造的 [CLIENT/TGS SESSIONKEY] 可以成功解密 Authenticator 1 并完成与 TGT 中的数据进行比对，便成功骗过了 KDC，也就是成功伪造了黄金票据</p></li><li><p>4.1 Client 向 SSService Server 发送服务请求<br>– 客户端向服务器发送的为使用 SERVICE 密钥 (服务器的 NTLMHASH) 加密的 CLIENT-TO-SERVER TICKET Ticket 中包含用来供服务器解密 Authenticator 2 的 CLIENT/SERVER SESSIONKEY 。如果获取到了 Service Server 的 NTLM Hash，便可伪造 Ticket，和 Authenticator 2 ，Service Server 在接收到 Ticket 和 Authenticator 2 后可以使用自己的 NTLM Hash 正常解密完成比对，也就是成功伪造了白银票据</p></li></ul><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1</span>、黄金票据与白银票据需要拿到krbtgt或者server用户的hash，所以只能做为后门使用</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2</span>、白银票据利用之后无日志，所以比黄金票据更好</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3</span>、关于Service Hash，Service Hash其实是目标中一个用户名与hostname相同的用户的Hash</pre></td></tr><tr><td data-num="4"></td><td><pre>如hostname为<span class="token constant">PC</span><span class="token operator">-</span><span class="token constant">WIN7</span><span class="token literal-property property">的服务器，对应的Hash就是Username</span> <span class="token operator">:</span> <span class="token constant">PC</span><span class="token operator">-</span><span class="token constant">WIN7</span>$的哈希</pre></td></tr></table></figure><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126154653353.png" alt="image-20211126154653353"></p><h5 id="黄金白银票据"><a class="anchor" href="#黄金白银票据">#</a> 黄金白银票据</h5><h6 id="白银票据"><a class="anchor" href="#白银票据">#</a> 白银票据</h6><ul><li><p>原理（伪造 Server Hash 被加密的 Ticket）</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>Client 向Server 发起请求的时候，票据为Server <span class="token function">Hash</span><span class="token punctuation">(</span>Ticket<span class="token punctuation">)</span>和Server Session <span class="token function">Key</span><span class="token punctuation">(</span>Client Info<span class="token operator">+</span>Timestamp<span class="token punctuation">)</span>而Server 除了Server Hash以外，其他都是不知道的；</pre></td></tr><tr><td data-num="2"></td><td><pre>从而，一旦知道了Server Hash后，就可以伪造Server Session Key并生成伪造的Ticket和伪造的Server Session <span class="token function">Key</span><span class="token punctuation">(</span>Client Info<span class="token operator">+</span>Timestamp<span class="token punctuation">)</span>；</pre></td></tr><tr><td data-num="3"></td><td><pre>将伪造的Ticket使用Server Hash加密，就得到了伪造的Server <span class="token function">Hash</span><span class="token punctuation">(</span>Ticket<span class="token punctuation">)</span>；</pre></td></tr><tr><td data-num="4"></td><td><pre>最后将伪造的Server <span class="token function">Hash</span><span class="token punctuation">(</span>Ticket<span class="token punctuation">)</span>和Server Session <span class="token function">Key</span><span class="token punctuation">(</span>Client Info<span class="token operator">+</span>Timestamp<span class="token punctuation">)</span>发送给Srever 即可以验证通过。</pre></td></tr></table></figure></li><li><p>特点</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>需要目标服务的<span class="token constant">NTML</span> Hash，即Server Hash；</pre></td></tr><tr><td data-num="2"></td><td><pre>不需要与<span class="token constant">KDC</span> 交互；</pre></td></tr><tr><td data-num="3"></td><td><pre>只能访问指定服务器；</pre></td></tr></table></figure></li></ul><h6 id="黄金票据"><a class="anchor" href="#黄金票据">#</a> 黄金票据</h6><ul><li><p>原理（伪造被 krbtgt Hash 加密的 TGT）</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>在Client向<span class="token constant">AS</span> 发送验证信息的时候，验证消息为：</pre></td></tr><tr><td data-num="2"></td><td><pre>Session <span class="token function">Key</span><span class="token punctuation">(</span>Client Info<span class="token operator">+</span>Timestamp<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Client Info<span class="token operator">+</span>Server Info</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token constant">KDC</span> <span class="token function">Hash</span><span class="token punctuation">(</span><span class="token constant">TGT</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>而<span class="token constant">AS</span> 又是使用<span class="token constant">KDC</span> Hash（krbtgt Hash）解密<span class="token constant">KDC</span> <span class="token function">Hash</span><span class="token punctuation">(</span><span class="token constant">TGT</span><span class="token punctuation">)</span>得到<span class="token constant">TGT</span>，并从<span class="token constant">TGT</span>中获得session Key；</pre></td></tr><tr><td data-num="6"></td><td><pre>最后再利用Session Key去解密Session <span class="token function">Key</span><span class="token punctuation">(</span>Client Info<span class="token operator">+</span>Timestamp<span class="token punctuation">)</span>获得Client Info<span class="token operator">+</span>Server Info，去对比未加密的Client Info<span class="token operator">+</span>Server Info是否一致从而验证客户端身份；</pre></td></tr><tr><td data-num="7"></td><td><pre>所以，如果知道了<span class="token constant">KDC</span> Hash（krbtgt Hash）就可以伪造session Key，从而伪造<span class="token constant">KDC</span> <span class="token function">Hash</span><span class="token punctuation">(</span><span class="token constant">TGT</span><span class="token punctuation">)</span>，进而发送伪造的：</pre></td></tr><tr><td data-num="8"></td><td><pre>Session <span class="token function">Key</span><span class="token punctuation">(</span>Client Info<span class="token operator">+</span>Timestamp<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>Client Info<span class="token operator">+</span>Server Info</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token constant">KDC</span> <span class="token function">Hash</span><span class="token punctuation">(</span><span class="token constant">TGT</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>最终达到身份验证的目的；</pre></td></tr></table></figure></li><li><p>特点</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>需要<span class="token constant">KDC</span> Hash（krbtgt Hash）；</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token constant">AS</span>直接验证通过；</pre></td></tr><tr><td data-num="3"></td><td><pre>可以访问任意服务器；</pre></td></tr></table></figure></li></ul><h3 id="00x03域前置简单了解"><a class="anchor" href="#00x03域前置简单了解">#</a> 00x03. 域前置简单了解</h3><h4 id="原理"><a class="anchor" href="#原理">#</a> 原理</h4><p>域前置（Domain fronting），是一种隐藏连接真实端点来规避互联网审查的技术。在应用层上运作时，域前置使用户能通过 HTTPS 连接到被屏蔽的服务，而表面上像是在与另一个完全不同的站点通信。</p><p><img data-src="https://21r000-image.oss-cn-shanghai.aliyuncs.com/pic2021/image-20211126172348403.png" alt="image-20211126172348403"></p><p>假设有两个主机，<span class="exturl" data-url="aHR0cDovL3huLS13d3ctYzg4ZHA3b21neThqczhqLmEueG4tLWNvbXd3dy01cDdpLmIuY29t">域名分别为 www.a.com 与 www.b.com</span>。这两个主机都是被 ip 为 1.1.1.1 的 cdn 进行加速的。</p><p>这时候使用 curl 命令请求 cdn 1.1.1.1，并自定义 host 段为 www.b.com 的话。就会返回 www.b.com 的页面。</p><p>命令为： <code>curl 1.1.1.1 -H &quot;Host: www.b.com&quot; -v</code></p><p>同理请求同样的 cdn，<span class="exturl" data-url="aHR0cDovL3huLS1ob3N0d3d3LWk3M2t1MWZ1NjRjamZ2Z3VjLmEuY29t">但是将 host 改为 www.a.com</span>, 这时候就会返回 A 页面的信息。</p><p>如果将 curl 后请求的 ip 改为 <span class="exturl" data-url="aHR0cDovL3d3dy5hLmNvbQ==">www.a.com</span>, host 改为 <span class="exturl" data-url="aHR0cDovL3d3dy5iLmNvbQ==">www.b.com</span>。命令为：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>Curl www.a.com -H <span class="token string">"Host: www.b.com"</span> -v</pre></td></tr></table></figure><p>上述命令还是显示的是 www.b.com 的页面，<span class="exturl" data-url="aHR0cDovL3huLS13d3ctdnM5ZHc4OWZ4aGYxcGJ4OHZqaXhzMnN6ZTdhc3pqLmIuY29t"> 所以最终请求的还是 www.b.com</span>。</p><p>所以，域前置技术的核心基础设施是 cdn。</p><p>当使用 https 的时候 (一般都会使用 https，http 明文流量容易被检测到)，技术实现的核心是在不同的通信层使用不同的域名，DNS 解析的时候跟 TLS 服务器名称指示 (sin), 的时候使用的是合法的 CDN 的域名或者 ip (建议使用域名)，但实际访问域名却是 host 上写的域名.</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>host头对于检查器是不可见的，但是对于接受https请求的前端服务器是可见的。</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>简单理解：</pre></td></tr><tr><td data-num="4"></td><td><pre>   表面看，头部 <span class="token constant">CDN</span> 通讯域名（我们看得到）；</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>   实际内部，尾部真实 <span class="token constant">IP</span>（我们看不到）。</pre></td></tr></table></figure><p>没有域名 emmmm，贴上链接了解一下先</p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODc0OTMwL2FydGljbGUvZGV0YWlscy8xMDc3NDI4NDM=">域前置技术的原理与 CS 上的实现</span><br><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNzg1NTYyP2l2a19zYT0xMDI0MzIwdQ==">为你的 C2 配置一个完美的隐藏</span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMjQzMTQ2">域前置水太深，偷学六娃来隐身 —— 域前置攻击复现</span></p><h2 id="感言"><a class="anchor" href="#感言">#</a> 感言：</h2><p>接触内网的第二天 emmmmm，好家伙直接给我整的一愣一愣的，跪求佬们带带 QAQ！！！</p><h2 id="参考链接"><a class="anchor" href="#参考链接">#</a> 参考链接：</h2><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d4aDAwMDBtbS9hcnRpY2xlL2RldGFpbHMvMTA1OTk2Mzk3">Windows 内网协议学习 NTLM 篇之 NTLM 基础介绍</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNjgxMzcz">windows 之 NTLM 认证</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vZW4tdXMvb3BlbnNwZWNzL3dpbmRvd3NfcHJvdG9jb2xzL21zLW5sbXAvNzYwYTk3ODgtYmQzMi00ZDllLTg3YWQtMmFhNTk3MDc4NmFj">2.2.1 NTLM Messages</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2lyb255MGVnb2lzdC9hcnRpY2xlL2RldGFpbHMvMTA5NDkzMTAz">内网渗透 ——WINDOWS 认证机制之 KERBEROS</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0ODc0NjQ1L2FydGljbGUvZGV0YWlscy8xMTkzODQyMTY/c3BtPTEwMDEuMjEwMS4zMDAxLjY2NTAuMSZhbXA7dXRtX21lZGl1bT1kaXN0cmlidXRlLnBjX3JlbGV2YW50Lm5vbmUtdGFzay1ibG9nLTIlN0VkZWZhdWx0JTdFQ1RSTElTVCU3RWRlZmF1bHQtMS5ub19zZWFyY2hfbGluayZhbXA7ZGVwdGhfMS11dG1fc291cmNlPWRpc3RyaWJ1dGUucGNfcmVsZXZhbnQubm9uZS10YXNrLWJsb2ctMiU3RWRlZmF1bHQlN0VDVFJMSVNUJTdFZGVmYXVsdC0xLm5vX3NlYXJjaF9saW5r">【渗透测试笔记】之【内网渗透 —— 彻底理解 Kerberos 认证和黄金白银票据】</span></p><div class="tags"><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag"><i class="ic i-tag"></i> 内网渗透</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-03-25 19:27:39" itemprop="dateModified" datetime="2022-03-25T19:27:39+08:00">2022-03-25</time> </span><span id="article/64fd8041.html" class="item leancloud_visitors" data-flag-title="windows认证系列和域前置的简单了解" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>21r000 <i class="ic i-at"><em>@</em></i>未入江湖，怎敢佩刀</li><li class="link"><strong>本文链接：</strong> <a href="https://www.21r000.xyz/article/64fd8041.html" title="windows认证系列和域前置的简单了解">https://www.21r000.xyz/article/64fd8041.html</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/article/86d50ac0.html" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;21r000-image.oss-cn-shanghai.aliyuncs.com&#x2F;pic2021&#x2F;6833939bly1gipeuibk9fj20zk0m8ay2.jpg" title="域的相关概念及配置"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 内网渗透</span><h3>域的相关概念及配置</h3></a></div><div class="item right"><a href="/article/c99fbb57.html" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;21r000-image.oss-cn-shanghai.aliyuncs.com&#x2F;pic2021&#x2F;6833939bly1gipewr8iypj20zk0m8b29.jpg" title="windows信息搜集篇（一）之（域工作组） 信息收集及工具使用"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 内网渗透</span><h3>windows信息搜集篇（一）之（域工作组） 信息收集及工具使用</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#00x01windows%E4%B9%8Bntlm%E8%AE%A4%E8%AF%81"><span class="toc-number">1.</span> <span class="toc-text">00x01.Windows 之 NTLM 认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ntlm%E7%9A%84%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">NTLM 的认证过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E8%AE%A4%E8%AF%81%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">本地认证的流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#windows%E7%BD%91%E7%BB%9C%E8%AE%A4%E8%AF%81"><span class="toc-number">1.3.</span> <span class="toc-text">windows 网络认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ntlm-%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.4.</span> <span class="toc-text">NTLM 协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%B8%B8%E7%94%A8%E7%AB%AF%E5%8F%A3"><span class="toc-number">1.5.</span> <span class="toc-text">内网渗透常用端口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ntlm%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81"><span class="toc-number">1.6.</span> <span class="toc-text">NTLM 身份验证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#00x02windows%E4%B9%8Bkerberos%E8%AE%A4%E8%AF%81"><span class="toc-number">2.</span> <span class="toc-text">00x02.Windows 之 Kerberos 认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E8%AE%A4%E8%AF%81kerberos"><span class="toc-number">2.1.</span> <span class="toc-text">域认证 Kerberos</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%A7%92%E8%89%B2"><span class="toc-number">2.2.</span> <span class="toc-text">系统角色</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kerberos%E7%9B%B8%E5%85%B3%E7%9A%84%E5%87%A0%E4%B8%AA%E6%A6%82%E5%BF%B5"><span class="toc-number">2.3.</span> <span class="toc-text">Kerberos 相关的几个概念：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kerbreros%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">2.4.</span> <span class="toc-text">Kerbreros 认证流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E8%BF%87%E7%A8%8B"><span class="toc-number">2.4.1.</span> <span class="toc-text">具体过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E7%94%A8%E6%88%B7%E7%99%BB%E9%99%86"><span class="toc-number">2.4.2.</span> <span class="toc-text">1、用户登陆</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1as%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">2.4.3.</span> <span class="toc-text">2、身份认证服务（AS）认证流程</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#21-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%90%91as%E5%8F%91%E9%80%81%E8%AE%A4%E8%AF%81%E8%AF%B7%E6%B1%82"><span class="toc-number">2.4.3.1.</span> <span class="toc-text">2.1 客户端向 AS 发送认证请求</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#22-as%E7%A1%AE%E8%AE%A4client%E7%AB%AF%E7%99%BB%E5%BD%95%E8%80%85%E7%94%A8%E6%88%B7%E8%BA%AB%E4%BB%BD"><span class="toc-number">2.4.3.2.</span> <span class="toc-text">2.2 AS 确认 Client 端登录者用户身份</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E7%A5%A8%E6%8D%AE%E6%8E%88%E4%BA%88%E6%9C%8D%E5%8A%A1tgs%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">2.4.4.</span> <span class="toc-text">3、票据授予服务（TGS）认证流程</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#31-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%90%91tgs%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82%E6%9C%8D%E5%8A%A1%E6%8E%88%E6%9D%83%E8%AF%B7%E6%B1%82"><span class="toc-number">2.4.4.1.</span> <span class="toc-text">3.1 客户端向 TGS 发送请求服务授权请求</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#32-tgs%E4%B8%BAclient%E5%93%8D%E5%BA%94%E6%9C%8D%E5%8A%A1%E6%8E%88%E6%9D%83%E7%A5%A8%E6%8D%AE"><span class="toc-number">2.4.4.2.</span> <span class="toc-text">3.2 TGS 为 Client 响应服务授权票据</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4%E5%8F%91%E9%80%81%E6%9C%8D%E5%8A%A1%E8%AF%B7%E6%B1%82"><span class="toc-number">2.4.5.</span> <span class="toc-text">4. 发送服务请求</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#41-client%E5%90%91service-server%E5%8F%91%E9%80%81%E6%9C%8D%E5%8A%A1%E8%AF%B7%E6%B1%82"><span class="toc-number">2.4.5.1.</span> <span class="toc-text">4.1 Client 向 Service Server 发送服务请求</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#42-service-server%E5%93%8D%E5%BA%94client"><span class="toc-number">2.4.5.2.</span> <span class="toc-text">4.2 Service Server 响应 Client</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E4%B8%AD%E9%9C%80%E8%A6%81%E5%85%B3%E6%B3%A8%E7%9A%84%E7%82%B9%E7%A5%A8%E6%8D%AE%E4%BC%AA%E9%80%A0%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">2.4.5.3.</span> <span class="toc-text">认证流程中需要关注的点，票据伪造的原理</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="toc-number">2.4.6.</span> <span class="toc-text">黄金白银票据</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="toc-number">2.4.6.1.</span> <span class="toc-text">白银票据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">2.4.6.2.</span> <span class="toc-text">黄金票据</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#00x03%E5%9F%9F%E5%89%8D%E7%BD%AE%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3"><span class="toc-number">3.</span> <span class="toc-text">00x03. 域前置简单了解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">3.1.</span> <span class="toc-text">原理</span></a></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%84%9F%E8%A8%80"><span class="toc-number"></span> <span class="toc-text">感言：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number"></span> <span class="toc-text">参考链接：</span></a></li></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/article/86d50ac0.html" rel="bookmark" title="域的相关概念及配置">域的相关概念及配置</a></li><li class="active"><a href="/article/64fd8041.html" rel="bookmark" title="windows认证系列和域前置的简单了解">windows认证系列和域前置的简单了解</a></li><li><a href="/article/c99fbb57.html" rel="bookmark" title="windows信息搜集篇（一）之（域工作组） 信息收集及工具使用">windows信息搜集篇（一）之（域工作组） 信息收集及工具使用</a></li><li><a href="/article/33894e1d.html" rel="bookmark" title="工作组环境中进行内网渗透常见方法总结">工作组环境中进行内网渗透常见方法总结</a></li><li><a href="/article/fad2c18a.html" rel="bookmark" title="linux下信息搜集及msf工具用法">linux下信息搜集及msf工具用法</a></li><li><a href="/article/ffbd8b0.html" rel="bookmark" title="windows信息搜集篇（二）之SPN">windows信息搜集篇（二）之SPN</a></li><li><a href="/article/49a1e863.html" rel="bookmark" title="windows信息搜集篇（三）之凭证收集">windows信息搜集篇（三）之凭证收集</a></li><li><a href="/article/85cc03e0.html" rel="bookmark" title="windows信息搜集篇（四）之内网存活主机探测的多种方式">windows信息搜集篇（四）之内网存活主机探测的多种方式</a></li><li><a href="/article/e26d51b.html" rel="bookmark" title="Windows信息搜集篇（五）之DPAPI 数据加密与Dns域传送漏洞利用">Windows信息搜集篇（五）之DPAPI 数据加密与Dns域传送漏洞利用</a></li><li><a href="/article/aea05eaa.html" rel="bookmark" title="内网渗透学习之 Net-NTLM Relay Attack">内网渗透学习之 Net-NTLM Relay Attack</a></li><li><a href="/article/9ce09b1b.html" rel="bookmark" title="域渗透——DNS记录的获取">域渗透——DNS记录的获取</a></li><li><a href="/article/4a3c5201.html" rel="bookmark" title="渗透技巧——通过命令行开启Windows系统的匿名访问共享">渗透技巧——通过命令行开启Windows系统的匿名访问共享</a></li><li><a href="/article/f6eb5c38.html" rel="bookmark" title="渗透技巧——利用SYSVOL还原组策略中保存的密码">渗透技巧——利用SYSVOL还原组策略中保存的密码</a></li><li><a href="/article/1df695da.html" rel="bookmark" title="Active Directory域服务：域信任">Active Directory域服务：域信任</a></li><li><a href="/article/cdbe6e7b.html" rel="bookmark" title="浅谈内网渗透中有关隧道的那些事儿">浅谈内网渗透中有关隧道的那些事儿</a></li><li><a href="/article/fc890dcf.html" rel="bookmark" title="Windows环境下信息收集与内网定位">Windows环境下信息收集与内网定位</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="21r000" data-src="/images/avatar.jpg"><p class="name" itemprop="name">21r000</p><div class="description" itemprop="description">固态规则长方体空间移动工程师</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">75</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">12</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">15</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item Github" data-url="aHR0cHM6Ly9naXRodWIuY29tLzIxcjAwMA==" title="https:&#x2F;&#x2F;github.com&#x2F;21r000"><i class="ic i-github"></i></span> <span class="exturl item QQ" data-url="dGVuY2VudDovL21lc3NhZ2UvP3Vpbj0yODU1MTQ1MTEzJlNpdGU9Jk1lbnU9eWVz" title="tencent:&#x2F;&#x2F;message&#x2F;?uin&#x3D;2855145113&amp;Site&#x3D;&amp;Menu&#x3D;yes"><i class="ic i-qq"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/books/" rel="section"><i class="ic i-instagram"></i>图书阁</a></li><li class="item"><a href="/encode/" rel="section"><i class="ic i-flag"></i>在线编码</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友联</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>传送阵</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/article/86d50ac0.html" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/article/c99fbb57.html" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" title="分类于 内网渗透">内网渗透</a></div><span><a href="/article/1df695da.html" title="Active Directory域服务：域信任">Active Directory域服务：域信任</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/vulnhub%E9%9D%B6%E6%9C%BA%E5%AE%9E%E6%88%98/" title="分类于 vulnhub靶机实战">vulnhub靶机实战</a></div><span><a href="/article/3f0418ee.html" title="vulnhub靶场实战-CH4INRULZ_v1.0.1">vulnhub靶场实战-CH4INRULZ_v1.0.1</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%B1%87%E7%BC%96/" title="分类于 汇编">汇编</a></div><span><a href="/article/28bedc94.html" title="汇编语言Studying Note之JMP和LOOP学习">汇编语言Studying Note之JMP和LOOP学习</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/STools/" title="分类于 STools">STools</a></div><span><a href="/article/ce12b2b3.html" title="Typroa-v1.0破解记录">Typroa-v1.0破解记录</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/SNote/" title="分类于 SNote">SNote</a></div><span><a href="/article/60ec5e3d.html" title="Just Do It For Play : bingdundun">Just Do It For Play : bingdundun</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" title="分类于 内网渗透">内网渗透</a></div><span><a href="/article/9ce09b1b.html" title="域渗透——DNS记录的获取">域渗透——DNS记录的获取</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%B1%87%E7%BC%96/" title="分类于 汇编">汇编</a></div><span><a href="/article/f2951c20.html" title="汇编语言Studying Note之内联汇编">汇编语言Studying Note之内联汇编</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" title="分类于 内网渗透">内网渗透</a></div><span><a href="/article/33894e1d.html" title="工作组环境中进行内网渗透常见方法总结">工作组环境中进行内网渗透常见方法总结</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%B1%87%E7%BC%96/" title="分类于 汇编">汇编</a></div><span><a href="/article/c66b0376.html" title="汇编语言Studying Note之乘法与除法指令and扩展加减法学习">汇编语言Studying Note之乘法与除法指令and扩展加减法学习</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/STools/" title="分类于 STools">STools</a></div><span><a href="/article/38e1e532.html" title="Burp Suite Professional 2022.2.2破解记录">Burp Suite Professional 2022.2.2破解记录</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2021 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-"></i> </span><span class="author" itemprop="copyrightHolder">21r000 @ 21r000</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">302k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">4:35</span></div><div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_pv">本站总访问量：<span id="busuanzi_value_site_pv"></span>次</span> <span class="post-meta-divider">|</span> <span id="busuanzi_container_site_uv" style="display:none">本站访客数：<span id="busuanzi_value_site_uv"></span>人</span></div><div class="beian-info"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">浙ICP备2022001000号-1</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"article/64fd8041.html",favicon:{show:"（●´3｀●）大通りからジェーンまで",hide:"(´Д｀)金を独行する"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,model:{jsonPath:"/live2dw/assets/wanko.model.json"},display:{position:"right",width:150,height:200},mobile:{show:!1},log:!1})</script></body></html><!-- rebuild by hrmmi -->